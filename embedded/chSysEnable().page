---
title: ChibiOS/RT chSysEnable()
categories: embedded, arm, stm32, stm32f429
toc: yes
...

chSysEnable()
==============
| 在 GCC ports / ARMCMx 中，chSysEnable()是藉由設定 PRIMASK 和 BASEPRI 這2個中斷遮罩暫存器(Interrupt Mask Register)
| 來啟用所有的中斷資源
| 
| In ChibiOS-RT-Community / os / kernel / include / chsys.h

.. code-block:: c

    #define chSysEnable() {                                                        \
      dbg_check_enable();                                                          \
      port_enable();                                                               \
    } 

port_enable(): In ChibiOS-RT-Community / os / ports / GCC / ARMCMx / chcore_v7m.h

.. code-block:: c

    /**
    * @brief   Enables all the interrupt sources.
    * @note    In this port it lowers the base priority to user level.
    */
    #if !CORTEX_SIMPLIFIED_PRIORITY || defined(__DOXYGEN__)
    #define port_enable() {                                                     \
      register uint32_t tmp asm ("r3") = CORTEX_BASEPRI_DISABLED;               \
      asm volatile ("msr     BASEPRI, %0                    \n\t"               \
                    "cpsie   i" : : "r" (tmp) : "memory");                      \
    //cpsie: Change Program State Interrupt Enable.Clear PRIMASK, enable interrupts
    }


| 首先利用 msr 指令將 0x00 寫入 BASEPRI 暫存器，這樣一來便不會對中斷的優先度進行比對，使得正常中斷(IRQ)和快速中斷(FIQ)均可以使用
| 之後再利用 "cpsie i" 是將 PRIMASK 暫存器給清空，達到啟用所有中斷資源的效果

